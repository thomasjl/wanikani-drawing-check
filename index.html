<!doctype html>
<html lang=\"fr\">
<head>
  <meta charset=\"utf-8\" />
  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />
  <title>Kanji Write Check ‚Äî WaniKani (v2, SRS + Dashboard, FIX)</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, \"Noto Sans JP\", Arial, sans-serif; margin: 2rem; }
    header { display:flex; gap:1rem; flex-wrap:wrap; align-items:flex-end; }
    input[type=\"text\"], select { padding:.5rem; font-size:1rem; }
    button { padding:.6rem 1rem; font-size:1rem; margin-right:.5rem; cursor:pointer; }
    .card { border:1px solid #8883; border-radius:12px; padding:1rem; margin-top:1rem; }
    .label { font-size:.9rem; color:#666; }
    .meaning { font-size:1.4rem; }
    .kanji { font-size:4rem; line-height:1.2; margin-top:.25rem; display:none; }
    .readings { font-size:1rem; color:#555; display:none; }
    .controls { margin-top:1rem; }
    .stats { margin-top:.75rem; color:#444; }
    .hint { font-size:.85rem; color:#666; margin-top:.5rem; }
    .error { color:#b00020; white-space:pre-wrap; }
    details { margin-top:1rem; }
    summary { cursor:pointer; }
    .diag-grid { display:grid; grid-template-columns: 220px 1fr; gap:.25rem .75rem; }
    .diag-grid div:nth-child(odd) { color:#666; }
    .dash { margin-top:1rem; padding:1rem; border:1px dashed #8884; border-radius:12px; }
    .dash h2 { margin:.2rem 0 1rem; font-size:1.2rem; }
    .dash .row { display:flex; gap:1rem; flex-wrap:wrap; }
    .badge { padding:.25rem .5rem; border-radius:8px; background:#8881; }
    .chart { margin-top:1rem; height:120px; display:flex; align-items:flex-end; gap:.4rem; }
    .bar { width:22px; background:#4a8; border-radius:4px 4px 0 0; }
  </style>
</head>
<body>
<header id=\"app-header\">
  <div id=\"token-block\">
    <div class=\"label\">Token WaniKani (lecture seule)</div>
    <input id=\"token\" type=\"text\" size=\"48\" placeholder=\"wk_...\" />
    <button id=\"saveToken\">Enregistrer (cookie)</button>
    <button id=\"clearToken\">Effacer le cookie</button>
  </div>
  <div id=\"mode-block\">
    <div class=\"label\">S√©lection</div>
    <select id=\"mode\">
      <option value=\"now\">Kanji √† r√©viser maintenant</option>
      <option value=\"unlocked\">Tous les kanji d√©bloqu√©s (non br√ªl√©s)</option>
      <option value=\"level\">Kanji d‚Äôun niveau pr√©cis‚Ä¶</option>
    </select>
    <input id=\"level\" type=\"number\" min=\"1\" max=\"60\" placeholder=\"lvl\" style=\"width:5rem; display:none;\" />
    <button id=\"load\">Charger</button>
  </div>
</header>

<div id=\"status\" class=\"hint\"></div>
<div id=\"error\" class=\"error\"></div>

<div id=\"card\" class=\"card\" hidden>
  <div class=\"label\">Sens (anglais)</div>
  <div id=\"meaning\" class=\"meaning\"></div>

  <div id=\"kanji\" class=\"kanji\" lang=\"ja\"></div>
  <div id=\"readings\" class=\"readings\"></div>

  <div class=\"controls\">
    <button id=\"show\">Afficher le kanji</button>
    <button id=\"success\">J‚Äôai r√©ussi ‚úçÔ∏è</button>
    <button id=\"fail\">Je me suis tromp√©</button>
    <button id=\"next\">Suivant ‚ñ∂Ô∏é</button>
  </div>
  <div id=\"stats\" class=\"stats\"></div>
</div>

<div id=\"dashboard\" class=\"dash\">
  <h2>üìä Dashboard SRS</h2>
  <div class=\"row\">
    <span class=\"badge\" id=\"dash-acc\">Acc.: ‚Äî</span>
    <span class=\"badge\" id=\"dash-now\">Due now: ‚Äî</span>
    <span class=\"badge\" id=\"dash-24\">24h: ‚Äî</span>
    <span class=\"badge\" id=\"dash-stages\">A:‚Äî | G:‚Äî | M:‚Äî | E:‚Äî | B:‚Äî</span>
  </div>
  <div class=\"chart\" id=\"chart\"></div>
</div>

<details id=\"diagnostics\">
  <summary>üîé Diagnostics (headers & requ√™tes)</summary>
  <div class=\"diag-grid\" id=\"diag-grid\">
    <div>Derni√®re URL :</div><div id=\"diag-url\">‚Äî</div>
    <div>HTTP Status :</div><div id=\"diag-status\">‚Äî</div>
    <div>RateLimit-Limit :</div><div id=\"diag-limit\">‚Äî</div>
    <div>RateLimit-Remaining :</div><div id=\"diag-remaining\">‚Äî</div>
    <div>RateLimit-Reset (epoch s) :</div><div id=\"diag-reset\">‚Äî</div>
    <div>Last-Modified :</div><div id=\"diag-last\">‚Äî</div>
    <div>ETag :</div><div id=\"diag-etag\">‚Äî</div>
  </div>
</details>

<footer class=\"hint\">
  Conseils : dessine sur papier, puis <b>affiche</b> le kanji pour te corriger.
  API : <code>Authorization: Bearer &lt;token&gt;</code> et <code>Wanikani-Revision: 20170710</code>.
</footer>

<script>
(() => {
  const API = 'https://api.wanikani.com/v2';
  const REVISION = '20170710';
  const state = { queue: [], index: 0, ok: 0, ko: 0, cache: JSON.parse(localStorage.getItem('wk_subject_cache')||'{}'), lastHeaders:{}, lastUrl:'', lastStatus:'' };
  const SRS_STAGES = {1:{name:'Apprentice 1',intervalHours:4},2:{name:'Apprentice 2',intervalHours:8},3:{name:'Apprentice 3',intervalHours:24},4:{name:'Apprentice 4',intervalHours:48},5:{name:'Guru 1',intervalHours:24*7},6:{name:'Guru 2',intervalHours:24*14},7:{name:'Master',intervalHours:24*30},8:{name:'Enlightened',intervalHours:24*120},9:{name:'Burned',intervalHours:Infinity}};
  function applyIncorrectPenalty(currentStage, wrongCount){ const c=Math.ceil(wrongCount/2); const f=(currentStage>=5)?2:1; return Math.max(1, currentStage - c*f); }

  const $ = sel => document.querySelector(sel);
  function info(msg){ const s=$('#status'); if (s) s.textContent=msg; }
  function showError(err){ const e=$('#error'); const msg=(typeof err==='string')?err:(err?.message||'Erreur inconnue'); if(e) e.textContent=msg; }
  function resetUI(){ const e=$('#error'), s=$('#status'), card=$('#card'), k=$('#kanji'), r=$('#readings'); if(e) e.textContent=''; if(s) s.textContent=''; if(card) card.hidden=true; if(k) k.style.display='none'; if(r) r.style.display='none'; state.ok=0; state.ko=0; updateStats(); }

  function ensureUiElements(){
    // Cr√©e les blocs manquants pour √©viter l'erreur "#token introuvable"
    const header = $('#app-header') || document.body;
    if (!$('#token')) {
      const block = document.createElement('div'); block.id='token-block';
      block.innerHTML = `<div class="label">Token WaniKani (lecture seule)</div>
        <input id="token" type="text" size="48" placeholder="wk_..." />
        <button id="saveToken">Enregistrer (cookie)</button>
        <button id="clearToken">Effacer le cookie</button>`;
      header.prepend(block);
    }
    if (!$('#mode')) {
      const block = document.createElement('div'); block.id='mode-block';
      block.innerHTML = `<div class="label">S√©lection</div>
        <select id="mode"><option value="now">Kanji √† r√©viser maintenant</option><option value="unlocked">Tous les kanji d√©bloqu√©s (non br√ªl√©s)</option><option value="level">Kanji d‚Äôun niveau pr√©cis‚Ä¶</option></select>
        <input id="level" type="number" min="1" max="60" placeholder="lvl" style="width:5rem; display:none;" />
        <button id="load">Charger</button>`;
      header.appendChild(block);
    }
    // Carte et boutons
    if (!$('#card')){
      const card = document.createElement('div'); card.id='card'; card.className='card'; card.hidden=true;
      card.innerHTML = `<div class="label">Sens (anglais)</div><div id="meaning" class="meaning"></div>
        <div id="kanji" class="kanji" lang="ja"></div><div id="readings" class="readings"></div>
        <div class="controls"><button id="show">Afficher le kanji</button><button id="success">J‚Äôai r√©ussi ‚úçÔ∏è</button><button id="fail">Je me suis tromp√©</button><button id="next">Suivant ‚ñ∂Ô∏é</button></div>
        <div id="stats" class="stats"></div>`;
      document.body.appendChild(card);
    }
  }

  function must(selector){ const el=$(selector); if(!el){ console.warn(`[Init] ${selector} introuvable, cr√©ation auto.`); ensureUiElements(); return $(selector); } return el; }

  // cookies
  function setTokenCookie(token){ const maxAge=60*60*24*365; document.cookie = `wk_token=${encodeURIComponent(token)}; Max-Age=${maxAge}; Path=/; SameSite=Lax; Secure`; }
  function getTokenCookie(){ const m=document.cookie.match(/(?:^|; )wk_token=([^;]*)/); return m?decodeURIComponent(m[1]):''; }
  function clearTokenCookie(){ document.cookie=`wk_token=; Max-Age=0; Path=/; SameSite=Lax; Secure`; }
  function getToken(tokenInput){ const c=getTokenCookie(); const i=(tokenInput.value||'').trim(); const ls=(localStorage.getItem('wk_token')||'').trim(); const t=(c||i||ls).trim(); if(!t) throw new Error('‚ö†Ô∏è Token requis.'); return t; }

  function updateDiagnostics(url,res){ state.lastUrl=url; state.lastStatus=`${res.status} ${res.statusText}`; state.lastHeaders={limit:res.headers.get('RateLimit-Limit'),remaining:res.headers.get('RateLimit-Remaining'),reset:res.headers.get('RateLimit-Reset'),etag:res.headers.get('ETag'),last:res.headers.get('Last-Modified')}; const set=(id,v)=>{const n=$(id); if(n) n.textContent=v||'‚Äî';}; set('#diag-url',state.lastUrl); set('#diag-status',state.lastStatus); set('#diag-limit',state.lastHeaders.limit); set('#diag-remaining',state.lastHeaders.remaining); set('#diag-reset',state.lastHeaders.reset); set('#diag-etag',state.lastHeaders.etag); set('#diag-last',state.lastHeaders.last); }

  async function fetchJson(url,token){ const res=await fetch(url,{headers:{'Authorization':`Bearer ${token}`,'Wanikani-Revision':REVISION}}); updateDiagnostics(url,res); if(res.status===429){ const reset=Number(res.headers.get('RateLimit-Reset'))||0; const now=Math.floor(Date.now()/1000); const waitMs=Math.max((reset-now),3)*1000; info(`‚è≥ ${Math.round(waitMs/1000)}s‚Ä¶`); await new Promise(r=>setTimeout(r,waitMs)); return fetchJson(url,token);} if(!res.ok){ let body=''; try{body=await res.text();}catch{} let msg=`HTTP ${res.status} ‚Äî ${res.statusText}`; if(body){ try{ const j=JSON.parse(body); if(j.error) msg=`HTTP ${res.status} ‚Äî ${j.error}`;}catch{ msg=`HTTP ${res.status} ‚Äî ${body}`; } } throw new Error(msg);} return res.json(); }

  async function fetchAssignments(token,modeSelect,levelInput){ const mode=modeSelect.value; let qs=`subject_types=kanji&hidden=false`; if(mode==='now'){ const now=new Date().toISOString(); qs+=`&available_before=${encodeURIComponent(now)}`; } else if(mode==='unlocked'){ qs+=`&unlocked=true&burned=false`; } else { const lvl=Number((levelInput&&levelInput.value)||0); if(!lvl||lvl<1||lvl>60) throw new Error('Niveau 1‚Äì60.'); qs+=`&levels=${lvl}&unlocked=true&burned=false`; } const url=`${API}/assignments?${qs}`; const first=await fetchJson(url,token); let items=first.data||[]; let next=first.pages?.next_url; while(next){ const page=await fetchJson(next,token); items=items.concat(page.data||[]); next=page.pages?.next_url; } return items; }

  async function fetchSubjects(ids,token){ const unique=Array.from(new Set(ids)); const subjects=[]; const chunkSize=950; for(let i=0;i<unique.length;i+=chunkSize){ const chunk=unique.slice(i,i+chunkSize); const url=`${API}/subjects?ids=${chunk.join(',')}`; try{ const json=await fetchJson(url,token); subjects.push(...(json.data||[])); let next=json.pages?.next_url; while(next){ const page=await fetchJson(next,token); subjects.push(...(page.data||[])); next=page.pages?.next_url; } }catch(e){ for(const id of chunk){ if(state.cache[id]){ subjects.push(state.cache[id]); continue;} const single=await fetchJson(`${API}/subjects/${id}`,token); const normalized=single.data?single:{data:single}; state.cache[id]=normalized; subjects.push(normalized);} localStorage.setItem('wk_subject_cache',JSON.stringify(state.cache)); } } return subjects.filter(s=> (s.data?.object||s.object)==='kanji' || s.data?.characters ); }

  function loadSrsStore(){ return JSON.parse(localStorage.getItem('wk_srs_store')||'{}'); }
  function saveSrsStore(store){ localStorage.setItem('wk_srs_store', JSON.stringify(store)); }
  function seedSrsWithSubjects(subjects){ const store=loadSrsStore(); for(const s of subjects){ const d=s.data||s; const id=d.id||s.id; if(!store[id]){ store[id]={ subject_id:id, characters:d.characters, meaning:(d.meanings||[]).find(m=>m.primary)?.meaning || (d.meanings||[])[0]?.meaning || '', readings:(d.readings||[]).map(r=>`${r.type}: ${r.reading}`), srs_stage:1, next_review_at:new Date().toISOString(), stats:{correct:0,incorrect:0}, last_seen_at:null }; } } saveSrsStore(store); }
  function getDueNowQueue(){ const store=loadSrsStore(); const now=Date.now(); const due=[]; const byId=Object.fromEntries(state.queue.map(it=>[it.id||it.subject_id,it])); for(const [id,it] of Object.entries(store)){ const dueAt=Date.parse(it.next_review_at); if(dueAt<=now && it.srs_stage<9){ due.push({ id:Number(id), characters:it.characters||byId[id]?.characters, meaning:it.meaning||byId[id]?.meaning, readings:it.readings||byId[id]?.readings, srs_stage:it.srs_stage }); } } for(let i=due.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [due[i],due[j]]=[due[j],due[i]];} return due; }
  function scheduleNext(itemId,success,wrongCount=1){ const store=loadSrsStore(); const it=store[itemId]; if(!it) return; const now=new Date(); it.last_seen_at=now.toISOString(); if(success){ it.srs_stage=Math.min(9,it.srs_stage+1); it.stats.correct++; } else { it.srs_stage=applyIncorrectPenalty(it.srs_stage,wrongCount); it.stats.incorrect++; } const hours=SRS_STAGES[it.srs_stage].intervalHours; const next=(hours===Infinity)?new Date(now.getTime()+365*24*3600*1000):new Date(now.getTime()+hours*3600*1000); it.next_review_at=next.toISOString(); store[itemId]=it; saveSrsStore(store); }

  function renderDashboard(){ const store=loadSrsStore(); const stages={A:0,G:0,M:0,E:0,B:0}; let correct=0,incorrect=0; const now=Date.now(); const dueNow=[], due24=[]; for(const it of Object.values(store)){ const s=it.srs_stage; if(s<=4) stages.A++; else if(s<=6) stages.G++; else if(s==7) stages.M++; else if(s==8) stages.E++; else stages.B++; correct+=it.stats.correct; incorrect+=it.stats.incorrect; const d=Date.parse(it.next_review_at); if(s<9){ if(d<=now) dueNow.push(it); else if(d-now<=24*3600*1000) due24.push(it);} } const acc=(correct+incorrect)?Math.round(100*correct/(correct+incorrect)):100; const set=(id,text)=>{const el=document.getElementById(id); if(el) el.textContent=text;}; set('dash-acc',`Acc.: ${acc}%`); set('dash-now',`Due now: ${dueNow.length}`); set('dash-24',`24h: ${due24.length}`); set('dash-stages',`A:${stages.A} | G:${stages.G} | M:${stages.M} | E:${stages.E} | B:${stages.B}`);
    const buckets=new Array(8).fill(0); for(const it of due24){ const delta=Date.parse(it.next_review_at)-now; const h=Math.ceil(delta/3600000); const idx=Math.min(7,Math.max(0,Math.floor((h-1)/3))); buckets[idx]++; }
    const chart=document.getElementById('chart'); if(chart){ chart.innerHTML=''; const labels=['0-3h','3-6h','6-9h','9-12h','12-15h','15-18h','18-21h','21-24h']; const max=Math.max(1,*buckets); buckets.forEach((val,i)=>{ const bar=document.createElement('div'); bar.className='bar'; bar.style.height=`${Math.round(100*val/max)}%`; bar.title=`${labels[i]}: ${val}`; chart.appendChild(bar); }); }
  }

  async function startSessionWithDueNow(token){ seedSrsWithSubjects(state.queue); state.queue=getDueNowQueue(); state.index=0; renderDashboard(); renderCard(); if(!state.queue.length) info('Aucun item d√ª maintenant.'); }
  function renderCard(){ const card=$('#card'); if(!state.queue.length){ if(card) card.hidden=true; return; } const item=state.queue[state.index%state.queue.length]; const meaning=$('#meaning'), kanji=$('#kanji'), readings=$('#readings'); if(meaning) meaning.textContent=item.meaning||''; if(kanji){ kanji.textContent=item.characters||''; kanji.style.display='none'; } if(readings){ readings.textContent=(item.readings||[]).join(' ‚Ä¢ '); readings.style.display='none'; } if(card) card.hidden=false; updateStats(); }
  function nextCard(){ if(!state.queue.length) return; state.index=(state.index+1)%state.queue.length; renderCard(); }
  function updateStats(){ const s=$('#stats'); if(s) s.textContent=`Score: ${state.ok} bon / ${state.ko} faux ‚Ä¢ Item ${state.index+1}/${Math.max(1,state.queue.length)}`; }

  document.addEventListener('DOMContentLoaded', () => {
    ensureUiElements();
    const tokenInput = must('#token'); const saveBtn=must('#saveToken'); const clearBtn=must('#clearToken');
    const modeSelect=must('#mode'); const levelInput=must('#level'); const loadBtn=must('#load');
    const showBtn=must('#show'); const successBtn=must('#success'); const failBtn=must('#fail'); const nextBtn=must('#next');

    const cookieToken=getTokenCookie(); if(cookieToken) tokenInput.value=cookieToken;
    modeSelect.addEventListener('change',()=>{ levelInput.style.display=(modeSelect.value==='level')?'inline-block':'none'; });
    saveBtn.addEventListener('click',()=>{ const t=(tokenInput.value||'').trim(); if(!t) return showError('‚ö†Ô∏è Token vide.'); setTokenCookie(t); info('‚úÖ Token enregistr√© dans un cookie.'); });
    clearBtn.addEventListener('click',()=>{ clearTokenCookie(); info('üßπ Cookie effac√©.'); });

    loadBtn.addEventListener('click', async ()=>{
      try{ resetUI(); const token=getToken(tokenInput); info('Connexion √† WaniKani‚Ä¶');
        const assignments=await fetchAssignments(token,modeSelect,levelInput); if(!assignments.length){ info('Aucun kanji pour ce filtre.'); return; }
        const subjects=await fetchSubjects(assignments.map(a=>a.data.subject_id), token);
        state.queue = subjects.map(s=>{ const d=s.data||s; return { id:d.id||s.id, characters:d.characters, meaning:(d.meanings||[]).find(m=>m.primary)?.meaning || (d.meanings||[])[0]?.meaning || '', readings:(d.readings||[]).map(r=>`${r.type}: ${r.reading}`) }; });
        await startSessionWithDueNow(token);
      } catch(e){ showError(e); console.error('[Load Error]', e); }
    });

    showBtn.addEventListener('click',()=>{ const k=$('#kanji'), r=$('#readings'); if(k) k.style.display='block'; if(r) r.style.display='block'; });
    successBtn.addEventListener('click',()=>{ const cur=state.queue[state.index%state.queue.length]; if(cur){ scheduleNext(cur.id||cur.subject_id,true,0); state.ok++; } renderDashboard(); nextCard(); });
    failBtn.addEventListener('click',()=>{ const cur=state.queue[state.index%state.queue.length]; if(cur){ scheduleNext(cur.id||cur.subject_id,false,1); state.ko++; } renderDashboard(); nextCard(); });
    nextBtn.addEventListener('click',()=> nextCard());

    renderDashboard();
  });
})();
</script>
</body>
</html>
